<!-- Scale Control Component for Digital Twin IDE PWA -->
<template>
    <div class="scale-control">
        <div class="property-section">
            <h6><i class="bi bi-zoom-in"></i> <span data-i18n="scale.title">Component Scale/Zoom</span></h6>
            
            <!-- Current Scale Display -->
            <div class="mb-3 p-2 bg-light rounded">
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted" data-i18n="scale.currentScale">Current Scale:</small><br>
                        <strong data-bind="scaleInfo.displayText">100%</strong>
                    </div>
                    <div class="col-6 text-end">
                        <small class="text-muted" data-i18n="scale.dimensions">Dimensions:</small><br>
                        <small data-bind="scaleInfo.scaledDimensions">100x100px</small>
                        <small class="text-muted d-none" data-bind="scaleInfo.originalDimensions"></small>
                    </div>
                </div>
            </div>
            
            <!-- Scale Controls -->
            <div class="row g-2 mb-2">
                <div class="col-12">
                    <label class="form-label small" data-i18n="scale.scalePercent">Scale (% of original size)</label>
                    <div class="input-group input-group-sm">
                        <button class="btn btn-outline-dark" type="button" data-action="zoom-out">
                            <i class="bi bi-zoom-out"></i>
                        </button>
                        <input type="range" class="form-range" 
                               min="10" max="500" step="25" 
                               data-bind="scaleInfo.percentage"
                               data-action="scale-input"
                               style="flex: 1; margin: 0 10px; align-self: center;">
                        <button class="btn btn-outline-dark" type="button" data-action="zoom-in">
                            <i class="bi bi-zoom-in"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Precise Scale Input -->
            <div class="row g-2 mb-2">
                <div class="col-8">
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" 
                               data-bind="scaleInfo.percentage"
                               data-action="scale-percent-input"
                               placeholder="100%"
                               data-i18n-placeholder="scale.placeholder">
                        <button class="btn btn-outline-primary" type="button" data-action="reset-scale">
                            <span data-i18n="scale.reset">Reset 100%</span>
                        </button>
                    </div>
                </div>
                <div class="col-4">
                    <select class="form-select form-select-sm" data-action="zoom-level-select">
                        <option value="25">25%</option>
                        <option value="50">50%</option>
                        <option value="75">75%</option>
                        <option value="100" selected>100%</option>
                        <option value="125">125%</option>
                        <option value="150">150%</option>
                        <option value="200">200%</option>
                        <option value="300">300%</option>
                    </select>
                </div>
            </div>
            
            <!-- Quick Zoom Buttons - Compact -->
            <div class="scale-buttons-grid">
                <button class="scale-btn" data-action="set-scale" data-value="50">50%</button>
                <button class="scale-btn active" data-action="set-scale" data-value="100">100%</button>
                <button class="scale-btn" data-action="set-scale" data-value="150">150%</button>
                <button class="scale-btn" data-action="set-scale" data-value="200">200%</button>
            </div>
            
            <div class="text-center mt-2">
                <small class="text-muted">
                    <i class="bi bi-aspect-ratio"></i> 
                    <span data-i18n="scale.aspectRatio">Aspect ratio preserved</span> | 
                    <span data-i18n="scale.svgTransform">SVG transform:</span> 
                    <span data-bind="scaleInfo.scaleText">scale(1.00)</span>
                </small>
            </div>
        </div>
    </div>
</template>

<style>
    .scale-control {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    .scale-buttons-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .scale-btn {
        padding: 0.25rem 0.5rem;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .scale-btn:hover {
        background-color: #f8f9fa;
        border-color: #adb5bd;
    }
    
    .scale-btn.active {
        background-color: #0d6efd;
        color: white;
        border-color: #0a58ca;
    }
    
    @media (prefers-color-scheme: dark) {
        .scale-btn {
            background-color: #2d3748;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        
        .scale-btn:hover {
            background-color: #4a5568;
            border-color: #718096;
        }
        
        .scale-btn.active {
            background-color: #3b82f6;
            border-color: #2563eb;
        }
    }
</style>

<script type="module">
import { ModuleBase, registerModule } from '../base/module-base.js';
import { I18nMixin } from '../base/i18n-mixin.js';

class ScaleControl extends I18nMixin(ModuleBase) {
    constructor() {
        super();
        this.scaleInfo = {
            displayText: '100%',
            scaledDimensions: '0x0px',
            originalDimensions: '0x0px',
            percentage: 100,
            scale: 1.0,
            scaleText: 'scale(1.00)'
        };
        this.componentId = null;
    }

    static get observedAttributes() {
        return ['component-id'];
    }

    attributeChangedCallback(name, oldValue, newValue) {
        if (name === 'component-id' && oldValue !== newValue) {
            this.componentId = newValue;
            this.updateScaleInfo();
        }
    }

    async init() {
        await super.init();
        await this.loadModuleTranslations('scale-control');
        this.componentId = this.getAttribute('component-id');
        this.updateScaleInfo();
    }

    bindEvents() {
        // Zoom in/out buttons
        this.on('click', '[data-action="zoom-in"]', () => this.adjustScale(25));
        this.on('click', '[data-action="zoom-out"]', () => this.adjustScale(-25));
        
        // Scale input range
        this.on('input', '[data-action="scale-input"]', (e) => {
            const value = parseInt(e.target.value);
            this.setScalePercentage(value);
        });
        
        // Percentage input
        this.on('change', '[data-action="scale-percent-input"]', (e) => {
            const value = parseInt(e.target.value);
            if (!isNaN(value)) {
                this.setScalePercentage(value);
            }
        });
        
        // Reset button
        this.on('click', '[data-action="reset-scale"]', () => {
            this.setScalePercentage(100);
        });
        
        // Zoom level select
        this.on('change', '[data-action="zoom-level-select"]', (e) => {
            const value = parseInt(e.target.value);
            if (!isNaN(value)) {
                this.setScalePercentage(value);
            }
        });
        
        // Quick scale buttons
        this.on('click', '[data-action="set-scale"]', (e) => {
            const value = parseInt(e.target.dataset.value);
            if (!isNaN(value)) {
                this.setScalePercentage(value);
            }
        });
    }

    updateScaleInfo() {
        if (!this.componentId) return;
        
        // In a real implementation, this would fetch the actual scale info
        // For now, we'll just update with dummy data
        const element = document.getElementById(this.componentId);
        if (!element) return;
        
        // This would be replaced with actual scale calculation
        const scaleInfo = this.getComponentScaleInfo(element);
        this.scaleInfo = {
            ...scaleInfo,
            scaleText: `scale(${scaleInfo.scale.toFixed(2)})`
        };
        
        this.updateBindings();
    }
    
    getComponentScaleInfo(svgElement) {
        // This would be replaced with actual implementation
        // For now, return some default values
        return {
            displayText: '100%',
            scaledDimensions: '100x100px',
            originalDimensions: '100x100px',
            percentage: 100,
            scale: 1.0
        };
    }
    
    adjustScale(delta) {
        const newPercentage = Math.max(10, Math.min(500, this.scaleInfo.percentage + delta));
        this.setScalePercentage(newPercentage);
    }
    
    setScalePercentage(percentage) {
        if (isNaN(percentage)) return;
        
        // Clamp between 10% and 500%
        const newPercentage = Math.max(10, Math.min(500, parseInt(percentage)));
        
        // Update the UI
        this.scaleInfo.percentage = newPercentage;
        this.scaleInfo.scale = newPercentage / 100;
        this.scaleInfo.scaleText = `scale(${(newPercentage / 100).toFixed(2)})`;
        
        // Update active state of quick buttons
        this.shadowRoot.querySelectorAll('.scale-btn').forEach(btn => {
            const btnValue = parseInt(btn.dataset.value);
            if (btnValue === newPercentage) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        
        // Update the select element
        const select = this.shadowRoot.querySelector('[data-action="zoom-level-select"]');
        if (select) {
            select.value = newPercentage;
        }
        
        // Dispatch event to notify parent component
        this.dispatchEvent(new CustomEvent('scale-change', {
            detail: {
                componentId: this.componentId,
                percentage: newPercentage,
                scale: this.scaleInfo.scale
            },
            bubbles: true,
            composed: true
        }));
        
        this.updateBindings();
    }
    
    updateBindings() {
        // Update all elements with data-bind attributes
        this.shadowRoot.querySelectorAll('[data-bind]').forEach(element => {
            const binding = element.dataset.bind;
            if (binding.includes('.')) {
                const [obj, prop] = binding.split('.');
                if (this[obj] && this[obj][prop] !== undefined) {
                    element.textContent = this[obj][prop];
                }
            }
        });
    }
}

registerModule('scale-control', ScaleControl);
</script>
