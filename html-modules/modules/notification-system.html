<!-- Notification System HTML Module for Digital Twin IDE PWA -->
<template id="notification-system-template">
    <div class="notification-system">
        <div class="notifications-container">
            <!-- Notifications will be dynamically inserted here -->
        </div>
    </div>
</template>

<style>
    .notification-system {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        pointer-events: none;
        max-width: 400px;
    }

    .notifications-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .notification {
        background: var(--bg-primary, #ffffff);
        border: 1px solid var(--border-color, #dee2e6);
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        pointer-events: auto;
        transform: translateX(100%);
        opacity: 0;
        transition: all 0.3s ease;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        position: relative;
        overflow: hidden;
    }

    .notification.show {
        transform: translateX(0);
        opacity: 1;
    }

    .notification.success {
        border-left: 4px solid var(--success-color, #28a745);
        background: var(--success-bg, #d4edda);
    }

    .notification.warning {
        border-left: 4px solid var(--warning-color, #ffc107);
        background: var(--warning-bg, #fff3cd);
    }

    .notification.error {
        border-left: 4px solid var(--error-color, #dc3545);
        background: var(--error-bg, #f8d7da);
    }

    .notification.info {
        border-left: 4px solid var(--info-color, #17a2b8);
        background: var(--info-bg, #d1ecf1);
    }

    .notification-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
    }

    .notification-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 14px;
        color: var(--text-primary, #212529);
    }

    .notification-icon {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
    }

    .notification-close {
        background: none;
        border: none;
        padding: 4px;
        cursor: pointer;
        color: var(--text-secondary, #6c757d);
        border-radius: 3px;
        transition: all 0.2s ease;
    }

    .notification-close:hover {
        background: var(--bg-hover, #e9ecef);
        color: var(--text-primary, #212529);
    }

    .notification-message {
        font-size: 13px;
        color: var(--text-secondary, #6c757d);
        line-height: 1.4;
        margin-bottom: 8px;
    }

    .notification-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
    }

    .notification-btn {
        padding: 4px 12px;
        border: 1px solid var(--border-color, #ced4da);
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: var(--bg-primary, #ffffff);
        color: var(--text-primary, #212529);
    }

    .notification-btn:hover {
        background: var(--bg-hover, #e9ecef);
    }

    .notification-btn.primary {
        background: var(--primary-color, #007bff);
        color: white;
        border-color: var(--primary-color, #007bff);
    }

    .notification-btn.primary:hover {
        background: var(--primary-color-dark, #0056b3);
    }

    .notification-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 3px;
        background: var(--primary-color, #007bff);
        transition: width linear;
        border-radius: 0 0 8px 8px;
    }

    /* Dark theme support */
    @media (prefers-color-scheme: dark) {
        .notification-system {
            --bg-primary: #2d3748;
            --bg-hover: #4a5568;
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --border-color: #4a5568;
            --primary-color: #3182ce;
            --primary-color-dark: #2c5282;
            --success-color: #48bb78;
            --success-bg: #2d5a2d;
            --warning-color: #ed8936;
            --warning-bg: #5a4a2d;
            --error-color: #f56565;
            --error-bg: #5a2d2d;
            --info-color: #4299e1;
            --info-bg: #2d4a5a;
        }
    }
</style>

<script type="module">
    import { ModuleBase, registerModule } from '../base/module-base.js';
    import { I18nMixin } from '../base/i18n-mixin.js';

    class NotificationSystem extends I18nMixin(ModuleBase) {
        constructor() {
            super();

            this.notifications = new Map();
            this.defaultDuration = 5000;
            this.maxNotifications = 5;

            // Load notification translations
            this.loadTranslations('notifications');
        }

        connectedCallback() {
            super.connectedCallback();
            this.applyTranslations();
        }

        show(options) {
            const notification = this.createNotification(options);
            this.addNotification(notification);
            return notification.id;
        }

        success(message, options = {}) {
            return this.show({
                type: 'success',
                title: this.t('notification.success'),
                message: typeof message === 'string' ? message : JSON.stringify(message),
                icon: this.getSuccessIcon(),
                ...options
            });
        }

        warning(message, options = {}) {
            return this.show({
                type: 'warning',
                title: this.t('notification.warning'),
                message: typeof message === 'string' ? message : JSON.stringify(message),
                icon: this.getWarningIcon(),
                ...options
            });
        }

        error(message, options = {}) {
            return this.show({
                type: 'error',
                title: this.t('notification.error'),
                message: typeof message === 'string' ? message :
                         message instanceof Error ? message.message :
                         JSON.stringify(message),
                icon: this.getErrorIcon(),
                duration: 0, // Don't auto-dismiss errors
                ...options
            });
        }

        info(message, options = {}) {
            return this.show({
                type: 'info',
                title: this.t('notification.info'),
                message: typeof message === 'string' ? message : JSON.stringify(message),
                icon: this.getInfoIcon(),
                ...options
            });
        }

        createNotification(options) {
            const id = this.generateId();
            const {
                type = 'info',
                title = '',
                message = '',
                icon = null,
                duration = this.defaultDuration,
                actions = [],
                closable = true
            } = options;

            const notification = {
                id,
                type,
                title,
                message,
                icon,
                duration,
                actions,
                closable,
                timestamp: Date.now(),
                element: null,
                timeout: null
            };

            notification.element = this.createNotificationElement(notification);
            return notification;
        }

        createNotificationElement(notification) {
            const element = this.createElement('div', {
                className: `notification ${notification.type}`,
                'data-notification-id': notification.id
            });

            // Header
            const header = this.createElement('div', {
                className: 'notification-header'
            });

            const titleContainer = this.createElement('div', {
                className: 'notification-title'
            });

            if (notification.icon) {
                const iconEl = this.createElement('div', {
                    className: 'notification-icon'
                });
                iconEl.innerHTML = notification.icon;
                titleContainer.appendChild(iconEl);
            }

            const titleEl = this.createElement('span', {}, notification.title);
            titleContainer.appendChild(titleEl);

            header.appendChild(titleContainer);

            if (notification.closable) {
                const closeBtn = this.createElement('button', {
                    className: 'notification-close',
                    'aria-label': this.t('notification.close', 'Close notification')
                });
                closeBtn.innerHTML = this.getCloseIcon();
                closeBtn.addEventListener('click', () => {
                    this.dismiss(notification.id);
                });
                header.appendChild(closeBtn);
            }

            element.appendChild(header);

            // Message
            if (notification.message) {
                const messageEl = this.createElement('div', {
                    className: 'notification-message'
                }, notification.message);
                element.appendChild(messageEl);
            }

            // Actions
            if (notification.actions.length > 0) {
                const actionsEl = this.createElement('div', {
                    className: 'notification-actions'
                });

                notification.actions.forEach(action => {
                    const btn = this.createElement('button', {
                        className: `notification-btn ${action.primary ? 'primary' : ''}`
                    }, action.label);

                    btn.addEventListener('click', () => {
                        if (action.callback) {
                            action.callback(notification.id);
                        }
                        if (action.dismiss !== false) {
                            this.dismiss(notification.id);
                        }
                    });

                    actionsEl.appendChild(btn);
                });

                element.appendChild(actionsEl);
            }

            // Progress bar for timed notifications
            if (notification.duration > 0) {
                const progressEl = this.createElement('div', {
                    className: 'notification-progress'
                });
                progressEl.style.width = '100%';
                element.appendChild(progressEl);

                // Animate progress bar
                setTimeout(() => {
                    progressEl.style.width = '0%';
                    progressEl.style.transition = `width ${notification.duration}ms linear`;
                }, 100);
            }

            return element;
        }

        addNotification(notification) {
            const container = this.$('.notifications-container');
            if (!container) return;

            // Remove excess notifications
            while (this.notifications.size >= this.maxNotifications) {
                const oldestId = Array.from(this.notifications.keys())[0];
                this.dismiss(oldestId);
            }

            // Add to container
            container.appendChild(notification.element);
            this.notifications.set(notification.id, notification);

            // Trigger animation
            requestAnimationFrame(() => {
                notification.element.classList.add('show');
            });

            // Set auto-dismiss timer
            if (notification.duration > 0) {
                notification.timeout = setTimeout(() => {
                    this.dismiss(notification.id);
                }, notification.duration);
            }

            this.emit('notification-shown', { notification });
        }

        dismiss(id) {
            const notification = this.notifications.get(id);
            if (!notification) return;

            // Clear timeout
            if (notification.timeout) {
                clearTimeout(notification.timeout);
            }

            // Animate out
            notification.element.classList.remove('show');

            setTimeout(() => {
                if (notification.element.parentElement) {
                    notification.element.parentElement.removeChild(notification.element);
                }
                this.notifications.delete(id);

                this.emit('notification-dismissed', { id });
            }, 300);
        }

        dismissAll() {
            Array.from(this.notifications.keys()).forEach(id => {
                this.dismiss(id);
            });
        }

        generateId() {
            return 'notification-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        getSuccessIcon() {
            return `<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
            </svg>`;
        }

        getWarningIcon() {
            return `<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M7.938 2.016A.13.13 0 0 1 8.002 2a.13.13 0 0 1 .063.016.146.146 0 0 1 .054.057l6.857 11.667c.036.06.035.124.002.183a.163.163 0 0 1-.054.06.116.116 0 0 1-.066.017H1.146a.115.115 0 0 1-.066-.017.163.163 0 0 1-.054-.06.176.176 0 0 1 .002-.183L7.884 2.073a.147.147 0 0 1 .054-.057zm1.044-.45a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566z"/>
                <path d="M7.002 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 5.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995z"/>
            </svg>`;
        }

        getErrorIcon() {
            return `<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
            </svg>`;
        }

        getInfoIcon() {
            return `<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
            </svg>`;
        }

        getCloseIcon() {
            return `<svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
            </svg>`;
        }
    }

    registerModule('notification-system', NotificationSystem);
</script>
