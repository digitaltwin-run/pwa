<template id="header-template">
  <!--
    Digital Twin IDE Header Component
    Provides top navigation, language selector and toolbar functionality
  -->
  <header class="header-container">
    <!-- Language Selector -->
    <div class="language-switcher">
      <select id="language-select" aria-label="Select language">
        <option value="en">ðŸ‡ºðŸ‡¸ English</option>
        <option value="pl">ðŸ‡µðŸ‡± Polski</option>
        <option value="de">ðŸ‡©ðŸ‡ª Deutsch</option>
        <option value="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
        <option value="fr">ðŸ‡«ðŸ‡· FranÃ§ais</option>
        <option value="it">ðŸ‡®ðŸ‡¹ Italiano</option>
      </select>
    </div>

    <!-- Top Menu -->
    <nav class="top-menu">
      <ul>
        <li><a href="#" class="menu-item" data-action="file-menu" data-i18n="ui.menu.file">File</a></li>
        <li><a href="#" class="menu-item" data-action="tools-menu" data-i18n="ui.menu.tools">Tools</a></li>
        <li><a href="#" class="menu-item" data-action="view-menu" data-i18n="ui.menu.view">View</a></li>
        <li><a href="#" class="menu-item" data-action="help-menu" data-i18n="ui.menu.help">Help</a></li>
      </ul>
    </nav>

    <!-- Toolbar -->
    <div class="toolbar">
      <button class="btn btn-success" data-action="export-project" data-i18n="ui.buttons.export">
        Export (.dtwin)
      </button>
      <button class="btn btn-primary" data-action="import-project" data-i18n="ui.buttons.import">
        Import (.dtwin)
      </button>
      <button class="btn btn-warning" data-action="export-png" data-i18n="ui.buttons.exportPng">
        Export PNG
      </button>
      <button class="btn btn-primary" data-action="export-svg" data-i18n="ui.buttons.exportSvg">
        Export SVG
      </button>
      <button class="btn btn-purple" data-action="toggle-connection-mode" data-i18n="ui.buttons.connect">
        Connect Components
      </button>
    </div>
  </header>

    <style>
        /* Header styling */
        .header-container {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            background-color: #2c3e50;
            color: #ecf0f1;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Language selector */
        .language-switcher {
            margin-right: 1rem;
        }

        .language-switcher select {
            padding: 0.3rem;
            background-color: #34495e;
            color: #ecf0f1;
            border: 1px solid #7f8c8d;
            border-radius: 4px;
        }

        /* Top menu */
        .top-menu {
            flex: 1;
        }

        .top-menu ul {
            display: flex;
            list-style-type: none;
            margin: 0;
            padding: 0;
        }

        .top-menu li {
            margin-right: 1rem;
        }

        .top-menu a {
            color: #ecf0f1;
            text-decoration: none;
            padding: 0.3rem 0.5rem;
            border-radius: 3px;
            transition: background-color 0.2s;
        }

        .top-menu a:hover {
            background-color: #34495e;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: opacity 0.2s;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-warning {
            background-color: #f39c12;
            color: white;
        }

        .btn-purple {
            background-color: #8e44ad;
            color: white;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                padding: 0.5rem;
            }

            .language-switcher, .top-menu, .toolbar {
                margin: 0.3rem 0;
                width: 100%;
            }

            .toolbar {
                flex-wrap: wrap;
                justify-content: center;
            }

            .top-menu ul {
                justify-content: center;
            }
        }
    </style>

    <script type="module">
        import { I18nMixin } from '../base/i18n-mixin.js';
        import { ModuleBase } from '../base/module-base.js';

        /**
         * Header Component for Digital Twin IDE
         * Handles top menu actions, language selection and toolbar buttons
         */
        class HeaderComponent extends I18nMixin(ModuleBase) {
            constructor() {
                super();
                this.attachShadow({ mode: 'open' });
                
                // Bind methods
                this.handleLanguageChange = this.handleLanguageChange.bind(this);
                this.handleAction = this.handleAction.bind(this);
            }

            async connectedCallback() {
                await super.connectedCallback();
                
                // Initialize i18n
                await this.loadModuleTranslations('header');
                
                // Set up event listeners
                this.setupEventListeners();
                
                // Apply translations
                await this.applyTranslations();
                
                // Initialize language selector
                this.initializeLanguageSelector();
            }
            
            initializeLanguageSelector() {
                const select = this.shadowRoot.getElementById('language-select');
                if (select) {
                    select.addEventListener('change', this.handleLanguageChange);
                    
                    // Set initial language if available
                    if (window.i18nManager) {
                        select.value = window.i18nManager.currentLanguage || 'en';
                    }
                }
            }
            
            async handleLanguageChange(event) {
                const langCode = event.target.value;
                if (window.i18nManager) {
                    try {
                        await window.i18nManager.changeLanguage(langCode);
                        // Language changed successfully, update UI
                        await this.applyTranslations();
                        
                        // Dispatch event to update other components
                        document.dispatchEvent(new CustomEvent('language-changed', {
                            detail: { language: langCode }
                        }));
                    } catch (error) {
                        console.error('Error changing language:', error);
                    }
                }
            }
            
            setupEventListeners() {
                // Delegate click events for toolbar buttons and menu items
                this.shadowRoot.addEventListener('click', (event) => {
                    const button = event.target.closest('[data-action]');
                    if (button) {
                        const action = button.dataset.action;
                        this.handleAction(action, button);
                    }
                });
                
                // Listen for language changes from other components
                document.addEventListener('language-changed', (event) => {
                    if (event.detail?.language) {
                        const select = this.shadowRoot.getElementById('language-select');
                        if (select) {
                            select.value = event.detail.language;
                        }
                        this.applyTranslations();
                    }
                });
            }
            
            handleAction(action, element) {
                console.log(`[Header] Action: ${action}`);
                
                switch (action) {
                    case 'export-project':
                        this.emit('export-project');
                        break;
                        
                    case 'import-project':
                        this.emit('import-project');
                        break;
                        
                    case 'export-png':
                        this.emit('export-png');
                        break;
                        
                    case 'export-svg':
                        this.emit('export-svg');
                        break;
                        
                    case 'toggle-connection-mode':
                        this.emit('toggle-connection-mode');
                        break;
                        
                    case 'file-menu':
                    case 'tools-menu':
                    case 'view-menu':
                    case 'help-menu':
                        this.emit('menu-selected', { menu: action });
                        break;
                        
                    default:
                        console.warn(`[Header] Unknown action: ${action}`);
                }
            }
            
            disconnectedCallback() {
                // Clean up event listeners
                const select = this.shadowRoot.getElementById('language-select');
                if (select) {
                    select.removeEventListener('change', this.handleLanguageChange);
                }
                super.disconnectedCallback();
            }
        }
        
        // Register the component
        registerModule('app-header', HeaderComponent);
  </script>
</template>
