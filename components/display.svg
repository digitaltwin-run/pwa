<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="80" height="60" viewBox="0 0 80 60" preserveAspectRatio="none" data-component-params="label,color,url,refreshinterval,isactive,aspectratio,allowfullscreen,scalex,scaley,minwidth,minheight,preserveaspectratio,originalwidth,originalheight,padding,statusbarheight,ison,isblinking,blinkrate">
    <metadata>
        <component id="display-001" name="HTML Display" type="display">
            <parameters>
                <label>Display</label>
                <color>#3498db</color>
                <url>about:blank</url>
                <refreshInterval>0</refreshInterval>
                <isActive>true</isActive>
                <aspectRatio>16:9</aspectRatio>
                <allowFullScreen>true</allowFullScreen>
                <scaleX>1.0</scaleX>
                <scaleY>1.0</scaleY>
                <minWidth>40</minWidth>
                <minHeight>30</minHeight>
                <preserveAspectRatio>true</preserveAspectRatio>
                <originalWidth>80</originalWidth>
                <originalHeight>60</originalHeight>
                <padding>5</padding>
                <statusBarHeight>12</statusBarHeight>
                <ison>false</ison><isblinking>false</isblinking><blinkrate>500</blinkrate></parameters>
        </component>
    </metadata>

    <defs>
        <script>
        <![CDATA[
            (function() {
                // Function to read metadata from SVG
                function getMetadata(svgElement) {
                    var metadataElement = svgElement.querySelector('metadata component');
                    if (metadataElement) {
                        try {
                            var parametersElement = metadataElement.querySelector('parameters');
                            if (parametersElement) {
                                var result = {
                                    parameters: {
                                        url: parametersElement.querySelector('url')?.textContent || 'about:blank',
                                        refreshInterval: parseInt(parametersElement.querySelector('refreshInterval')?.textContent || '0'),
                                        isActive: parametersElement.querySelector('isActive')?.textContent !== 'false',
                                        aspectRatio: parametersElement.querySelector('aspectRatio')?.textContent || '16:9',
                                        label: parametersElement.querySelector('label')?.textContent || 'Display'
                                    }
                                };
                                return result;
                            }
                        } catch (e) {
                            console.warn('Error parsing display metadata:', e);
                        }
                    }
                    return {};
                }

                // Function to update display
                function updateDisplay(svgElement) {
                    var metadata = getMetadata(svgElement);
                    var params = metadata.parameters || {};
            // Public API
            function setDisplayUrl(url) {
                displayParams.url = url || 'about:blank';
                updateDisplay(document);
            }
            
            function setRefreshInterval(seconds) {
                displayParams.refreshInterval = Math.max(0, parseInt(seconds) || 0);
                setupRefreshTimer(document);
            }
            
            function setActive(isActive) {
                displayParams.isActive = isActive !== false;
                updateDisplay(document);
            }
            
            function setAspectRatio(ratio) {
                if (typeof ratio === 'string' && ratio.includes(':')) {
                    displayParams.aspectRatio = ratio;
                    updateDisplay(document);
                }
            }
            
            // Apply scaling to the SVG element
            function applyScaling(svgRoot) {
                if (!svgRoot) return;
                
                // Calculate new dimensions
                var newWidth = Math.max(displayParams.minWidth, displayParams.originalWidth * displayParams.scaleX);
                var newHeight = Math.max(displayParams.minHeight, displayParams.originalHeight * displayParams.scaleY);
                
                // Update SVG dimensions
                svgRoot.setAttribute('width', newWidth);
                svgRoot.setAttribute('height', newHeight);
                
                // Update viewBox to maintain proportions
                if (displayParams.preserveAspectRatio) {
                    svgRoot.setAttribute('preserveAspectRatio', 'xMidYMid meet');
                } else {
                    svgRoot.setAttribute('preserveAspectRatio', 'none');
                }
                
                // Update the display content container
                updateContentSize(svgRoot);
            }
            
            // Update the content container size based on current dimensions
            function updateContentSize(svgRoot) {
                var displayContent = svgRoot.getElementById('displayContent');
                if (!displayContent) return;
                
                // Calculate content area (with padding from metadata)
                var padding = displayParams.padding;
                var contentX = padding * displayParams.scaleX;
                var contentY = (displayParams.statusBarHeight + padding) * displayParams.scaleY;
                var contentWidth = displayParams.originalWidth * displayParams.scaleX - (2 * padding * displayParams.scaleX);
                var contentHeight = (displayParams.originalHeight - displayParams.statusBarHeight - padding) * displayParams.scaleY;
                
                // Update content container
                displayContent.setAttribute('x', contentX);
                displayContent.setAttribute('y', contentY);
                displayContent.setAttribute('width', contentWidth);
                displayContent.setAttribute('height', contentHeight);
                
                // Update status bar
                var statusBar = svgRoot.getElementById('statusBar');
                if (statusBar) {
                    statusBar.setAttribute('width', contentWidth);
                    statusBar.setAttribute('x', contentX);
                    statusBar.setAttribute('y', contentY);
                }
                
                // Update label position
                var label = svgRoot.getElementById('label');
                if (label) {
                    label.setAttribute('x', contentX + 5);
                    label.setAttribute('y', contentY + 10);
                }
            }
            
            // Make the display resizable
            function makeResizable(svg, svgRoot) {
                var resizeHandle = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                resizeHandle.setAttribute('class', 'resize-handle');
                
                // Calculate handle size based on component size (10% of the smaller dimension, with min/max limits)
                var handleSize = Math.max(
                    8, // min size
                    Math.min(
                        Math.min(displayParams.originalWidth, displayParams.originalHeight) * 0.1, 
                        15 // max size
                    )
                );
                
                // Position handle in bottom-right corner with small margin
                var handleMargin = 2;
                var handleX = displayParams.originalWidth - handleSize - handleMargin;
                var handleY = displayParams.originalHeight - handleSize - handleMargin;
                
                resizeHandle.setAttribute('x', handleX);
                resizeHandle.setAttribute('y', handleY);
                resizeHandle.setAttribute('width', handleSize);
                resizeHandle.setAttribute('height', handleSize);
                resizeHandle.setAttribute('fill', displayParams.color || '#3498db');
                resizeHandle.setAttribute('rx', '3');
                resizeHandle.setAttribute('style', 'cursor: nwse-resize;');
                
                svgRoot.appendChild(resizeHandle);
                
                var isResizing = false;
                var startX, startY, startWidth, startHeight, startScaleX, startScaleY;
                
                resizeHandle.addEventListener('mousedown', startResize);
                
                function startResize(e) {
                    e.stopPropagation();
                    isResizing = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    startWidth = parseFloat(svgRoot.getAttribute('width'));
                    startHeight = parseFloat(svgRoot.getAttribute('height'));
                    startScaleX = displayParams.scaleX;
                    startScaleY = displayParams.scaleY;
                    
                    document.addEventListener('mousemove', resize);
                    document.addEventListener('mouseup', stopResize);
                }
                
                function resize(e) {
                    if (!isResizing) return;
                    
                    var dx = e.clientX - startX;
                    var dy = e.clientY - startY;
                    
                    // Calculate new dimensions
                    var newWidth = Math.max(displayParams.minWidth, startWidth + dx);
                    var newHeight = Math.max(displayParams.minHeight, startHeight + dy);
                    
                    // Calculate scale factors
                    displayParams.scaleX = newWidth / displayParams.originalWidth;
                    displayParams.scaleY = newHeight / displayParams.originalHeight;
                    
                    // Apply scaling
                    applyScaling(svgRoot);
                    
                    // Update display content
                    updateDisplay(svg);
                }
                
                function stopResize() {
                    isResizing = false;
                    document.removeEventListener('mousemove', resize);
                    document.removeEventListener('mouseup', stopResize);
                }
            }
            
            // Public API for setting scale
            function setScale(scaleX, scaleY) {
                if (scaleX > 0) displayParams.scaleX = scaleX;
                if (scaleY > 0) displayParams.scaleY = scaleY;
                applyScaling(document.documentElement);
                updateDisplay(document);
            }
            
            // Public API for setting minimum dimensions
            function setMinDimensions(minWidth, minHeight) {
                if (minWidth > 0) displayParams.minWidth = minWidth;
                if (minHeight > 0) displayParams.minHeight = minHeight;
                applyScaling(document.documentElement);
                updateDisplay(document);
            }
        ]]>
        </script>
    </defs>

    <!-- Display frame -->
    <rect x="2" y="2" width="76" height="56" rx="4" fill="#ecf0f1" stroke="#bdc3c7" stroke-width="1"/>
    <rect x="5" y="5" width="70" height="50" rx="2" fill="#fff" stroke="#95a5a6" stroke-width="1"/>
    
    <!-- Status bar -->
    <rect id="statusBar" x="5" y="5" width="70" height="12" fill="#3498db" rx="2"/>
    <text id="label" x="10" y="15" font-size="8" fill="white">Display</text>
    
    <!-- Content will be inserted here by JavaScript -->
    
    <!-- Hidden style for resize handle -->
    <style>
        .resize-handle {
            fill: #3498db;
            cursor: nwse-resize;
            opacity: 0.7;
        }
        .resize-handle:hover {
            opacity: 1;
        }
    </style>
    <metadata>
        <component id="display-001" name="HMI Display" type="display">
            <parameters>
                <label>Panel</label>
                <color>#2c3e50</color>
                <text>Ready</text>
                <status>OK</status>
                <backlight>true</backlight>
            </parameters>
        </component>
    </metadata>


  <rect id="body" x="5" y="5" width="70" height="50" rx="8" fill="#2c3e50" stroke="#34495e" stroke-width="2"/>
  <rect x="15" y="15" width="50" height="20" fill="#ecf0f1" rx="4"/>
  <text id="label" x="40" y="48" font-size="12" text-anchor="middle" fill="#bdc3c7">Panel</text>
  <text id="value" x="40" y="28" font-size="14" text-anchor="middle" fill="#2c3e50">Ready</text>
</svg>